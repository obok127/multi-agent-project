<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>carat</title>
  <style>
    :root{
      --bg:#fff; --side:#f7f8fa; --line:#eaedf0; --text:#1f2937; --muted:#6b7280;
      --hint:#9aa1a9; --brand:#1976d2; --card:#ffffff; --shadow:0 8px 28px rgba(0,0,0,.06);
      --pill:#f3f4f6; --success:#16a34a; --sidebar-w:232px; --content-w:960px; --gutter:24px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex}

    /* Sidebar */
    .sidebar{width:var(--sidebar-w);background:var(--side);border-right:1px solid var(--line);display:flex;flex-direction:column;height:100vh;flex-shrink:0;position:fixed;top:0;left:0;z-index:100}
    .s-top{display:flex;align-items:center;gap:10px;padding:14px 16px 12px}
    .logo-dot{width:22px;height:22px;display:grid;place-items:center}
    .brand{font-weight:700;font-size:16px}
    .menu{padding:6px}
    .mi{display:flex;align-items:center;gap:10px;border-radius:10px;padding:10px 12px;color:#374151;cursor:pointer;user-select:none;font-size:14px;font-weight:500;transition:all 0.2s ease}
    .mi:hover{background:#eceff3;transform:translateX(2px)}
    .mi.active{background:#e8f2ff;color:#1256a5;transform:translateX(2px)}
    .icon{width:18px;display:grid;place-items:center}
    .section-title{font-size:12px;color:#8b95a1;padding:10px 12px 6px}
    .chat-list{display:flex;flex-direction:column;gap:6px;padding:0 6px 8px}
    .chat-item{border-radius:10px;background:#f2f4f7;padding:10px 12px;position:relative;cursor:pointer;transition:all 0.2s ease}
    .chat-item:hover{background:#e8f2ff;transform:translateX(2px)}
    .ci-title{font-size:13px;color:#374151}
    .ci-time{font-size:11px;color:#98a2b3;margin-top:2px}
    .delete-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;color:#9ca3af;border:none;border-radius:4px;width:24px;height:24px;font-size:14px;cursor:pointer;opacity:0;transition:all 0.2s;display:flex;align-items:center;justify-content:center}
    .delete-btn:hover{background:#f3f4f6;color:#ef4444}
    .chat-item:hover .delete-btn{opacity:1}
    .user{margin-top:auto;display:flex;align-items:center;gap:10px;padding:12px 14px 14px}
    .avatar{width:30px;height:30px;border-radius:50%;background:#ff9800;color:#fff;display:grid;place-items:center;font-weight:700;font-size:12px}
    .uname{font-size:13px;color:#374151}

    /* Main */
    .main{display:flex;flex-direction:column;height:100vh;flex:1;min-width:0;min-height:0;margin-left:var(--sidebar-w);overflow-y:auto}
    .topbar{height:56px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 18px;position:fixed;top:0;left:var(--sidebar-w);right:0;background:var(--bg);z-index:50}
    .title{font-size:15px;color:#4b5563;font-weight:700}
    .share{display:flex;align-items:center;gap:6px;background:var(--brand);color:#fff;border:none;border-radius:16px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer}
    .stage{text-align:center;margin-top:24vh;width:100%;max-width:960px;margin-left:auto;margin-right:auto}

    /* Input card */
    .ask-wrap{position:fixed;bottom:0;left:var(--sidebar-w);right:0;padding:16px 0 20px;background:linear-gradient(to top, rgba(255,255,255,.96) 60%, rgba(255,255,255,0));border-top:none;z-index:10}
    .ask{width:100%;max-width:960px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);min-height:64px;display:flex;flex-direction:column;gap:12px;padding:10px 14px}
    .button-row{display:flex;align-items:center;gap:12px;justify-content:center}
    .ask input{flex:1;border:none;outline:none;background:transparent;font-size:15px;color:#374151;margin-top:10px}
    .ask ::placeholder{color:#9aa3af}
    .icon-btn{background:none;border:none;cursor:pointer;width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-size:18px;color:#111}
    .icon-btn:hover{background:#f3f4f6}
    .ltools{position:static;left:auto;top:auto;transform:none;display:flex;gap:12px;color:#6b7280;font-size:18px}
    .tool-btn{background:none;border:none;cursor:pointer;padding:4px;border-radius:8px;color:#6b7280}
    .tool-btn:hover{background:#f3f4f6}

    /* ì±„íŒ…ì°½ ë‚´ë¶€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .chat-modal{display:none;position:absolute;bottom:calc(100% + 20px);left:50%;transform:translateX(-50%);width:100%;max-width:960px;background-color:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);margin-bottom:8px;z-index:1000}
    @keyframes chatModalSlideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .chat-modal-content{padding:0;animation:chatModalSlideUp 0.2s ease}
    .chat-modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e5e7eb}
    .chat-modal-header h3{margin:0;font-size:16px;font-weight:600;color:#111827}
    .chat-modal-body{padding:16px 20px}

    /* ë„êµ¬ ì˜µì…˜ ìŠ¤íƒ€ì¼ */
    .tool-option{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;cursor:pointer;transition:all 0.2s;margin-bottom:8px}
    .tool-option:hover{background:#f9fafb}
    .tool-option:last-child{margin-bottom:0}
    .tool-icon{font-size:20px;width:24px;text-align:center}
    .tool-text{font-size:14px;color:#374151;font-weight:500}

    /* AI ì´í™íŠ¸ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
    .effect-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .effect-item{cursor:pointer;border-radius:12px;overflow:hidden;transition:all 0.2s}
    .effect-item:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .effect-image{height:80px;border-radius:8px;margin-bottom:8px}
    .effect-text{font-size:12px;color:#374151;text-align:center;font-weight:500}

    /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .upload-area{border:2px dashed #d1d5db;border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all 0.2s}
    .upload-area:hover{border-color:#3b82f6;background:#f8fafc}
    .upload-icon{font-size:32px;margin-bottom:12px}
    .upload-text{font-size:16px;color:#374151;font-weight:500;margin-bottom:4px}
    .upload-hint{font-size:12px;color:#6b7280}
    
    /* ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .uploaded-image-container{position:relative;display:inline-block;margin-top:10px;border-radius:8px;overflow:hidden;border:1px solid #e5e7eb;max-width:80px;max-height:80px}
    .uploaded-image{width:80px;height:80px;object-fit:cover;display:block}
    .remove-image-btn{position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,0.8);color:#fff;border:none;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;z-index:10}
    .mic{margin-left:auto;width:36px;height:36px;border-radius:50%;background:var(--brand);color:#fff;border:none;cursor:pointer;display:grid;place-items:center;font-size:16px}
    .mic{font-weight:900}

    /* Chat thread */
    .thread{width:100%;max-width:960px;margin:56px auto 24px;padding-bottom:180px;text-align:left}
    .msg{display:flex;gap:10px;margin:10px 0;justify-content:flex-start;align-items:flex-start}
    .msg .bubble{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px 14px;box-shadow:0 1px 2px rgba(0,0,0,.04);max-width:80%;white-space:pre-wrap;line-height:1.5;text-align:left}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{background:#eaf2ff;border-color:#eaf2ff}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);color:#6b7280;border-radius:999px;padding:6px 10px;font-size:12px;margin:6px 0}
    .status.ok{color:var(--success)}
    .img-wrap{margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid var(--line)}
.img-wrap img{display:block;width:100%;height:auto}
.img-actions{margin-top:8px;display:flex;justify-content:center}
.save-btn{display:flex;align-items:center;gap:6px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:8px;padding:6px 12px;font-size:12px;color:#374151;cursor:pointer;transition:all 0.2s;font-weight:500}
    .save-btn:hover{background:#e5e7eb;transform:translateY(-1px)}
    .save-icon{font-size:14px}
    
    /* ì´ë¯¸ì§€ ê²°ê³¼ëŠ” ë§í’ì„  ì—†ì´ ë‹¨ë… ì¹´ë“œë¡œ */
    .row{display:flex;justify-content:center;margin:16px 0}
    .img-card{width:100%;max-width:540px;background:transparent;border:none;box-shadow:none;padding:0}
    .img-card .img-wrap img{max-width:100%;border-radius:12px;display:block}
    .img-card .actions{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}
    .img-card .btn{padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    
    /* ì²¨ë¶€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .attach{display:flex;gap:6px;margin-top:8px}
    .attach img{width:150px;height:150px;object-fit:cover;border-radius:6px}

    /* ë¬¼ê²°ì²˜ëŸ¼ ì›€ì§ì´ëŠ” ì  ì„¸ê°œ ì• ë‹ˆë©”ì´ì…˜ (ì¼ë°˜ LLM ë‹µë³€ìš©) */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 12px 14px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      max-width: 80px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #9ca3af;
      animation: typing-wave 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0s;
    }
    
    @keyframes typing-wave {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* ì´ë¯¸ì§€ ìƒì„±ìš© íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
    .image-typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 12px 14px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      max-width: 200px;
    }
    
    .image-typing-text {
      font-size: 14px;
      color: #374151;
      margin-right: 4px;
    }
    
    .image-typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #9ca3af;
      opacity: 0;
      animation: image-typing-dot 1.5s infinite;
    }
    
    .image-typing-dot:nth-child(1) {
      animation-delay: 0s;
    }
    
    .image-typing-dot:nth-child(2) {
      animation-delay: 0.5s;
    }
    
    .image-typing-dot:nth-child(3) {
      animation-delay: 1s;
    }
    
    @keyframes image-typing-dot {
      0%, 60%, 100% {
        opacity: 0;
        transform: scale(0.8);
      }
      20%, 40% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Sections hidden/show */
    .view{display:none}
    .view.active{display:block}
    h1{font-weight:700;font-size:26px;margin-bottom:28px}

    /* Container for centering content */
    .container{width:100%;max-width:960px;margin:0 auto}




  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="s-top" onclick="window.location.reload();" style="cursor:pointer;"><div class="logo-dot"><svg width="22" height="22" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-label="carat-logo">
      <g fill="#1E88FF">
        <ellipse cx="12" cy="6.2" rx="3" ry="5"/>
        <ellipse cx="12" cy="6.2" rx="3" ry="5" transform="rotate(72 12 12)"/>
        <ellipse cx="12" cy="6.2" rx="3" ry="5" transform="rotate(144 12 12)"/>
        <ellipse cx="12" cy="6.2" rx="3" ry="5" transform="rotate(216 12 12)"/>
        <ellipse cx="12" cy="6.2" rx="3" ry="5" transform="rotate(288 12 12)"/>
      </g>
      <circle cx="12" cy="12" r="2.2" fill="#1A73E8"/>
    </svg></div><div class="brand">carat</div></div>
    <nav class="menu">
      <div class="mi active" data-view="home" onclick="openNewChat()"><div class="icon">âœï¸</div>ìƒˆ ì±„íŒ…</div>
      <div class="mi" data-view="characters"><div class="icon">ğŸ¤–</div>ìºë¦­í„° ë´‡</div>
      <div class="mi" data-view="mini"><div class="icon">ğŸ”§</div>ë¯¸ë‹ˆ ì—ì´ì „íŠ¸</div>
      <div class="section-title">ì±„íŒ…</div>
      <div class="chat-list">
        <!-- ì±„íŒ… ëª©ë¡ì€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
      </div>
    </nav>
    <div class="user"><div class="avatar">U</div><div class="uname" id="userDisplayName">ì‚¬ìš©ì</div></div>
  </aside>

  <!-- Main -->
  <main class="main">
    <header class="topbar">
      <div class="title" id="headerTitle">ìºëŸ¿</div>
      <button class="share" onclick="downloadChatAsMarkdown()"><span>ğŸ“„</span> ê³µìœ í•˜ê¸°</button>
    </header>

    <section class="stage">
      <!-- HOME VIEW -->
      <div id="view-home" class="view active">
        <!-- ì œëª©ì€ ìš°ì¸¡ ì¹¼ëŸ¼ í­ ì•ˆì—ì„œ ê°€ìš´ë° ì •ë ¬ -->
        <div class="center">
          <h1>ìºëŸ¿ê³¼ í•¨ê»˜ ë¬´ì—‡ì„ ë§Œë“¤ì–´ë³¼ê¹Œìš”?</h1>
    </div>
    
        <!-- ìš°ì¸¡ ì¹¼ëŸ¼ ì½˜í…ì¸  ì»¨í…Œì´ë„ˆ -->
        <div class="container">
          <div class="thread" id="thread"></div>

          <div class="ask-wrap">
            <div class="ask">
              <input id="prompt" placeholder="ìºëŸ¿ì—ê²Œ ë¬´ì—‡ì´ë“  ë¶€íƒí•˜ì„¸ìš”" />
              <div class="button-row">
                <button class="icon-btn" id="addFileBtn" title="íŒŒì¼ ì¶”ê°€">ï¼‹</button>
                <button class="icon-btn" id="toolsBtn" title="ë„êµ¬">âš™ï¸</button>
                <button class="icon-btn" id="aiEffectBtn" title="AI ì´í™íŠ¸">âœ¨</button>
                <button id="sendBtn" class="mic" aria-label="ë³´ë‚´ê¸°">â–¶</button>
      </div>
      </div>

            <!-- ì±„íŒ…ì°½ ë‚´ë¶€ ëª¨ë‹¬ë“¤ (ask-wrap ë‚´ë¶€ì— ë‘ê³ , ë¶ˆí•„ìš”í•œ ë‹«í˜ ì œê±°) -->
            <div id="toolsModal" class="chat-modal">
              <div class="chat-modal-content">
                <div class="chat-modal-header">
                  <h3>ë„êµ¬</h3>
                  <button class="close-btn" onclick="closeChatModal('toolsModal')">Ã—</button>
      </div>
                <div class="chat-modal-body">
                  <div class="tool-option" onclick="selectTool('create-image')">
                    <div class="tool-icon">ğŸ¨</div><div class="tool-text">ì´ë¯¸ì§€ ë§Œë“¤ê¸°</div>
      </div>
                  <div class="tool-option" onclick="openChatModal('userEditModal')">
                    <div class="tool-icon">ğŸ–Œï¸</div><div class="tool-text">ë‚´ ì´ë¯¸ì§€ ì„ íƒ í¸ì§‘(1ì¥ + ì„¤ëª…)</div>
      </div>
                  <div class="tool-option" onclick="selectTool('create-video')">
                    <div class="tool-icon">ğŸ¬</div><div class="tool-text">ì˜ìƒ ë§Œë“¤ê¸°</div>
      </div>
                  <div class="tool-option" onclick="selectTool('enhance-quality')">
                    <div class="tool-icon">ğŸ“ˆ</div><div class="tool-text">í™”ì§ˆ ë†’ì´ê¸°</div>
      </div>
                  <div class="tool-option" onclick="selectTool('web-search')">
                    <div class="tool-icon">ğŸ”</div><div class="tool-text">ì›¹ ê²€ìƒ‰í•˜ê¸°</div>
      </div>
                  <div class="tool-option" onclick="selectTool('youtube-summary')">
                    <div class="tool-icon">ğŸ“º</div><div class="tool-text">ìœ íŠœë¸Œ ìš”ì•½í•˜ê¸°</div>
          </div>
          <!-- ì‚¬ìš©ì ì´ë¯¸ì§€ í¸ì§‘ ëª¨ë‹¬ (1ì¥ + ì„¤ëª…) -->
          <div id="userEditModal" class="chat-modal">
            <div class="chat-modal-content">
              <div class="chat-modal-header">
                <h3>ë‚´ ì´ë¯¸ì§€ ì„ íƒ í¸ì§‘</h3>
                <button class="close-btn" onclick="closeChatModal('userEditModal')">Ã—</button>
              </div>
              <div class="chat-modal-body">
                <div style="display:flex;flex-direction:column;gap:10px">
                  <input type="file" id="userEditFile" accept="image/*" />
                  <textarea id="userEditMsg" rows="3" placeholder="ì˜ˆ: ì„ íƒí•œ ê¼¬ë¦¬ë§Œ íŒŒìŠ¤í…” ë³´ë¼ìƒ‰ìœ¼ë¡œ, ìŠ¤íƒ€ì¼/ì„ /êµ¬ë„/ì¡°ëª…ì€ ìœ ì§€"></textarea>
                  <div style="display:flex;gap:8px;justify-content:flex-end">
                    <button class="tool-btn" onclick="closeChatModal('userEditModal')">ì·¨ì†Œ</button>
                    <button class="tool-btn" id="userEditSendBtn">ë³´ë‚´ê¸°</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
            <div id="aiEffectModal" class="chat-modal">
              <div class="chat-modal-content">
                <div class="chat-modal-header">
                  <h3>AI ì´í™íŠ¸</h3>
                  <button class="close-btn" onclick="closeChatModal('aiEffectModal')">Ã—</button>
                </div>
                <div class="chat-modal-body">
                  <div class="effect-grid">
                    <div class="effect-item" onclick="selectEffect('powder-explosion')">
                      <div class="effect-image" style="background:linear-gradient(45deg,#FF6B6B,#4ECDC4)"></div>
                      <div class="effect-text">íŒŒìš°ë” í­ë°œ</div>
                    </div>
                    <div class="effect-item" onclick="selectEffect('tiger-hug')">
                      <div class="effect-image" style="background:linear-gradient(45deg,#FFE66D,#FF6B6B)"></div>
                      <div class="effect-text">í˜¸ë‘ì´ í¬ì˜¹</div>
    </div>
                    <div class="effect-item" onclick="selectEffect('power-robot')">
                      <div class="effect-image" style="background:linear-gradient(45deg,#4ECDC4,#45B7D1)"></div>
                      <div class="effect-text">íŒŒì›Œ ë¡œë´‡</div>
  </div>
                    <div class="effect-item" onclick="selectEffect('venom')">
                      <div class="effect-image" style="background:linear-gradient(45deg,#2C3E50,#E74C3C)"></div>
                      <div class="effect-text">ë² ë†ˆ</div>
    </div>
            </div>
          </div>
        </div>
      </div>
      
            <div id="fileUploadModal" class="chat-modal">
              <div class="chat-modal-content">
                <div class="chat-modal-header">
                  <h3>íŒŒì¼ ì¶”ê°€</h3>
                  <button class="close-btn" onclick="closeChatModal('fileUploadModal')">Ã—</button>
                </div>
                <div class="chat-modal-body">
                  <input type="file" id="fileInput" accept="image/*" style="display: none;">
                  <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ–¼ï¸</div>
                    <div class="upload-text">ì´ë¯¸ì§€ ì„ íƒ</div>
                    <div class="upload-hint">ìµœëŒ€ 1ê°œì˜ ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥</div>
        </div>
            </div>
          </div>
            </div>
          </div>
        </div>


          </div>
          
      <!-- CHARACTERS (ëª©ë¡í˜•) -->
      <div id="view-characters" class="view">
        <div class="center" style="margin-top:24px;"><h1>ìƒˆë¡œ ë‚˜ì˜¨ ì¶”ì²œ ìºë¦­í„°</h1></div>
        <!-- ìƒ˜í”Œ ì¹´ë“œë“¤ì€ í•„ìš” ì‹œ ì¶”ê°€ -->
        <div class="thread" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px">
          <div style="background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden">
            <div style="background:linear-gradient(45deg,#FF6B6B,#4ECDC4);height:140px"></div>
            <div style="padding:12px 14px">
              <div style="font-weight:700">ì •í•˜ìœ¤ (æ­£æµæ®·)</div>
              <div style="color:#6b7280;font-size:13px;margin-top:6px">ë“œë¼ë§ˆí‹±í•œ í‘œì •, ë¶€ë“œëŸ¬ìš´ ì¡°ëª…</div>
            </div>
          </div>
          <!-- â€¦ ì›í•˜ëŠ” ë§Œí¼ ë³µì œ -->
            </div>
          </div>
          
      <!-- MINI-AGENT (ê·¸ë¦¬ë“œí˜•) -->
      <div id="view-mini" class="view">
        <div class="center" style="margin-top:24px;"><h1>ë¯¸ë‹ˆ ì—ì´ì „íŠ¸</h1></div>
        <div class="thread" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px">
          <div style="background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden">
            <div style="height:160px;background:#FFE9D6"></div>
            <div style="padding:14px 16px"><div style="font-weight:700">ì´ëª¨í‹°ì½˜ ë§Œë“¤ê¸°</div><div style="color:#6b7280;font-size:13px;margin-top:6px">AI ì´ëª¨í‹°ì½˜ ìƒì„±</div></div>
          </div>
          <div style="background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden">
            <div style="height:160px;background:#E3F2FD"></div>
            <div style="padding:14px 16px"><div style="font-weight:700">ëª¨ì…˜ê·¸ë˜í”½ ë§Œë“¤ê¸°</div><div style="color:#6b7280;font-size:13px;margin-top:6px">AI ëª¨ì…˜ê·¸ë˜í”½ ìƒì„±</div></div>
          </div>
          <div style="background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden">
            <div style="height:160px;background:#F3E5F5"></div>
            <div style="padding:14px 16px"><div style="font-weight:700">ì¦ëª…ì‚¬ì§„ ë§Œë“¤ê¸°</div><div style="color:#6b7280;font-size:13px;margin-top:6px">AI ì¦ëª…ì‚¬ì§„ ìƒì„±</div></div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <script>
    // === ì˜¨ë³´ë”© ìƒíƒœ ===
    let phase = 'ask-name'; // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë•Œë§ˆë‹¤ ì´ë¦„ ë¬»ê¸°ë¶€í„° ì‹œì‘
    let userName = null;
    let currentSessionId = 'fixed_session_' + Date.now(); // ê³ ì •ëœ ì„¸ì…˜ ID ì‚¬ìš©

    // ìƒˆ ì±„íŒ… ì°½ ì—´ê¸°
    function openNewChat() {
        // ìƒˆ ì°½ì—ì„œ í˜„ì¬ í˜ì´ì§€ ì—´ê¸°
        const newWindow = window.open(window.location.href, '_blank');
        
        // ìƒˆ ì°½ì´ ì—´ë¦¬ë©´ í˜„ì¬ ëŒ€í™”ë¥¼ ì €ì¥í•˜ê³  ìƒˆ ì°½ì—ì„œ ìƒˆ ëŒ€í™” ì‹œì‘
        if (newWindow) {
            // í˜„ì¬ ëŒ€í™”ê°€ ìˆìœ¼ë©´ ì €ì¥
            if (currentSessionId && thread.children.length > 0) {
                // í˜„ì¬ ëŒ€í™”ë¥¼ ì±„íŒ… ëª©ë¡ì— ì €ì¥í•˜ëŠ” ë¡œì§ì€ ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆìŒ
                console.log('í˜„ì¬ ëŒ€í™”ê°€ ìƒˆ ì°½ì—ì„œ ê³„ì†ë©ë‹ˆë‹¤.');
            }
        }
    }

    // í•œê¸€/ì˜ë¬¸ 2~10ì ì´ë¦„ ê²€ì¶œ(ë„ì–´ì“°ê¸° ì œê±°)
    function isLikelyName(text){
      if(!text) return false;
      const raw = String(text).trim();
      const compact = raw.replace(/\s+/g,'');
      return /^[ê°€-í£A-Za-z]{2,10}$/.test(compact);
    }
    function normalizeName(text){
      return String(text).trim().replace(/\s+/g,'').slice(0,10);
    }

    // ì²« ì§„ì… ë©”ì‹œì§€ ì¶œë ¥
    function bootOnboarding(){
      thread.innerHTML = ''; // ìƒˆë¡œê³ ì¹¨ë§ˆë‹¤ ì´ˆê¸° í™”ë©´
      
      // í•­ìƒ ì´ë¦„ ë¬»ê¸°ë¶€í„° ì‹œì‘
      const firstMessage = addBot(
`ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” <strong>ìºëŸ¿(Carat)</strong>ì´ì—ìš”. ğŸŒŸ
ë‹¤ì–‘í•œ ì§ˆë¬¸ì— ë‹µë³€ë“œë¦¬ê³ , ì´ë¯¸ì§€ë‚˜ ë¹„ë””ì˜¤, ì˜¤ë””ì˜¤ ì½˜í…ì¸ ë¥¼ ë§Œë“¤ì–´ë“œë¦¬ëŠ” ë“± ì—¬ëŸ¬ ê°€ì§€ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.
í˜¹ì‹œ ì„±í•¨ì´ ì–´ë–»ê²Œ ë˜ì‹œë‚˜ìš”? ì•ìœ¼ë¡œ ë” ê°œì¸í™”ëœ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ ê¸°ì–µí•´ë‘ê² ìŠµë‹ˆë‹¤! ğŸ˜Š`
      );
      
      // ì²« ë©”ì‹œì§€ì— ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
      if (firstMessage) {
        firstMessage.style.opacity = '0';
        firstMessage.style.transform = 'translateY(20px)';
        firstMessage.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        
        setTimeout(() => {
          firstMessage.style.opacity = '1';
          firstMessage.style.transform = 'translateY(0)';
        }, 100);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì‚¬ìš©ì ì´ë¦„ í™•ì¸
    async function checkSavedUserName() {
      // URL íŒŒë¼ë¯¸í„° ìš°ì„ 
      const urlParams = new URLSearchParams(window.location.search);
      let savedName = urlParams.get('user');
      // ì—†ìœ¼ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µì›
      if (!savedName) {
        savedName = localStorage.getItem('carat_user_name');
      }
      if (savedName) {
        userName = savedName;
        updateUserDisplay(savedName);
        updateChatList();
        phase = 'normal';
      }
    }

    // ì´ë¦„ í™•ì • í›„ ê³ ì • í¬ë§· ì¶œë ¥
    function printNameSavedAndGuide(name){
      // ì‚¬ìš©ì ì´ë¦„ì„ ì„œë²„ì— ì €ì¥
      fetch('/chat/api/user/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === "success") {
          console.log('ì‚¬ìš©ì ì´ë¦„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:', name);
          // ì‚¬ì´ë“œë°” ì‚¬ìš©ì ì´ë¦„ ì—…ë°ì´íŠ¸
          updateUserDisplay(name);
          // ì±„íŒ… ëª©ë¡ ì—…ë°ì´íŠ¸
          updateChatList();
        }
      })
      .catch(error => {
        console.error('ì‚¬ìš©ì ì´ë¦„ ì €ì¥ ì˜¤ë¥˜:', error);
      });

              // âœ… ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸ ì•ˆë‚´ (ë§í’ì„  ì—†ì´ pill í˜•íƒœ)
              addPill('âœ… ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'status ok');
      addBot(
`ì•ˆë…•í•˜ì„¸ìš”, ${name}ë‹˜! ğŸ˜Š ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”!
ì˜¤ëŠ˜ ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?
â€¢ ê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ì‹œê±°ë‚˜ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”
â€¢ ì´ë¯¸ì§€ë‚˜ ë¹„ë””ì˜¤, ìŒì•…ì„ ë§Œë“¤ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´ ë„ì™€ë“œë¦´ê²Œìš”
â€¢ ë²ˆì—­ì´ë‚˜ ê¸€ ì‘ì„± ê°™ì€ ì‘ì—…ë„ ê°€ëŠ¥í•´ìš”
â€¢ ê·¸ëƒ¥ í¸í•˜ê²Œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´ ê·¸ê²ƒë„ ì¢‹ì•„ìš”!
ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? âœ¨`
      );
    }

    // ì‚¬ì´ë“œë°” ì‚¬ìš©ì ì´ë¦„ ì—…ë°ì´íŠ¸
    function updateUserDisplay(name) {
      const userDisplayName = document.getElementById('userDisplayName');
      const avatar = document.querySelector('.user .avatar');
      
      if (userDisplayName) {
        userDisplayName.textContent = name;
      }
      
      if (avatar) {
        // ì´ë¦„ì˜ ì²« ê¸€ìë¥¼ ì•„ë°”íƒ€ë¡œ ì‚¬ìš©
        avatar.textContent = name.charAt(0).toUpperCase();
      }
    }

    // ===== View switching =====
    document.querySelectorAll('.mi[data-view]').forEach(el=>{
      el.addEventListener('click', ()=>{
        document.querySelectorAll('.mi').forEach(m=>m.classList.remove('active'));
        el.classList.add('active');
        const v = el.dataset.view;
        document.getElementById('headerTitle').textContent = v==='home'?'ìºëŸ¿':(v==='mini'?'ë¯¸ë‹ˆ ì—ì´ì „íŠ¸':'ìºë¦­í„° ë´‡');
        document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        
        // ìƒˆ ì±„íŒ…ì„ í´ë¦­í•œ ê²½ìš° ìƒˆ ì„¸ì…˜ ì‹œì‘
        if (v === 'home') {
          currentSessionId = null; // ì„¸ì…˜ ì´ˆê¸°í™”
          thread.innerHTML = '';
          if (phase === 'normal') {
            addBot('ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•´ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? âœ¨');
          } else {
            // ì˜¨ë³´ë”© ìƒíƒœë©´ ë‹¤ì‹œ ì˜¨ë³´ë”© í™”ë©´ í‘œì‹œ
            bootOnboarding();
          }
        }
      });
    });

    // ===== Chat UI helpers =====
    const thread = document.getElementById('thread');
    function addUser(text, files = null){ 
      const row = document.createElement('div');
      row.className = 'msg user';
      
      // ì´ë¯¸ì§€ë§Œ ìˆìœ¼ë©´ ë§í’ì„  ì—†ì´ ì´ë¯¸ì§€ë§Œ í‘œì‹œ
      if (files && files.length > 0 && !text) {
        const thumbs = files.slice(0,4).map(f => `<img src="${f.url || URL.createObjectURL(f)}">`).join('');
        row.innerHTML = `<div class="attach">${thumbs}</div>`;
      }
      // í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ ì¸ë„¤ì¼ ì•„ë˜ì— ë§í’ì„  ì•ˆì— í…ìŠ¤íŠ¸
      else if (files && files.length > 0 && text) {
        const thumbs = files.slice(0,4).map(f => `<img src="${f.url || URL.createObjectURL(f)}">`).join('');
        row.innerHTML = `
          <div class="attach">${thumbs}</div>
          <div class="bubble">
            ${escapeHtml(text)}
          </div>
        `;
      } else {
        // í…ìŠ¤íŠ¸ë§Œ ìˆìœ¼ë©´ ê¸°ì¡´ ë§í’ì„  ìŠ¤íƒ€ì¼
        row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
      }
      
      thread.appendChild(row);
      scrollToBottom(); 
    }
    function addBot(text){ const row=document.createElement('div');row.className='msg';row.innerHTML=`<div class="bubble">${linkify(text)}</div>`;thread.appendChild(row);scrollToBottom(); return row; }
    function addPill(text,cls=''){ const row=document.createElement('div');row.className='msg';row.innerHTML=`<div class="pill ${cls}">${escapeHtml(text)}</div>`;thread.appendChild(row);scrollToBottom(); return row; }
    // ì¤‘ì•™ í† ìŠ¤íŠ¸ íŒì—…
    function showToast(message, duration=1600){
      // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
      const old = document.getElementById('carat-toast');
      if (old) old.remove();
      const t = document.createElement('div');
      t.id = 'carat-toast';
      t.textContent = message;
      t.style = 'position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#111;color:#fff;border:1px solid #000;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:2000;opacity:0;transition:opacity .2s ease;font-size:14px;';
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.opacity = '1'; });
      setTimeout(()=>{
        t.style.opacity = '0';
        setTimeout(()=>{ t.remove(); }, 220);
      }, duration);
    }

    function addImage(url){ 
  const row=document.createElement('div');
  row.className='msg';
  row.innerHTML=`
    <div class="bubble">
      <div class="img-wrap" style="max-width: 540px; margin: 0 auto;">
        <img src="${url}" alt="result"/>
      </div>
      <div class="img-actions">
        <button class="save-btn" onclick="saveImage('${url}')">
          <span class="save-icon">ğŸ’¾</span>
          ì €ì¥
        </button>
        <button class="btn" onclick="regenerateImage('${url}')">ë‹¤ì‹œ ìƒì„±</button>
      </div>
    </div>
  `;
  thread.appendChild(row);
  scrollToBottom(); 
}
    function updatePill(row,newText,cls=''){ row.querySelector('.pill').textContent=newText;row.querySelector('.pill').className='pill '+cls; }
    
    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€/ì œê±°
    function addTypingIndicator() {
      const row = document.createElement('div');
      row.className = 'msg';
      row.id = 'typing-indicator';
      row.innerHTML = `
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      thread.appendChild(row);
      scrollToBottom();
      return row;
    }
    
    function addImageTypingIndicator() {
      const row = document.createElement('div');
      row.className = 'msg';
      row.id = 'image-typing-indicator';
      row.innerHTML = `
        <div class="image-typing-indicator">
          <span class="image-typing-text">ì´ë¯¸ì§€ ìƒì„± ì¤‘...</span>
          <div class="image-typing-dot"></div>
          <div class="image-typing-dot"></div>
          <div class="image-typing-dot"></div>
        </div>
      `;
      thread.appendChild(row);
      scrollToBottom();
      return row;
    }
    
    function removeTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) {
        indicator.remove();
      }
    }
    
    function removeImageTypingIndicator() {
      const indicator = document.getElementById('image-typing-indicator');
      if (indicator) {
        indicator.remove();
      }
    }
    function scrollToBottom(){ 
      const stage = document.querySelector('.stage');
      if (stage) {
        requestAnimationFrame(()=>{ 
          stage.scrollTo({top:stage.scrollHeight, behavior:'smooth'}); 
        }); 
      }
    }
    
    // ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜
    function saveImage(url) {
      try {
        // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ì„œ ë‹¤ìš´ë¡œë“œ
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
          const link = document.createElement('a');
          link.download = `carat-image-${Date.now()}.png`;
          link.href = canvas.toDataURL('image/png');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // ì €ì¥ ì™„ë£Œ ì•Œë¦¼
          const saveBtn = event.target.closest('.save-btn');
          if (saveBtn) {
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="save-icon">âœ…</span> ì €ì¥ë¨';
            saveBtn.style.background = '#dcfce7';
            saveBtn.style.color = '#166534';
            setTimeout(() => {
              saveBtn.innerHTML = originalText;
              saveBtn.style.background = '';
              saveBtn.style.color = '';
            }, 2000);
          }
        };
        img.onerror = function() {
          alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        };
        img.src = url;
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function linkify(s){ 
      // <strong> íƒœê·¸ëŠ” ë³´ì¡´í•˜ê³  ë‚˜ë¨¸ì§€ë§Œ ì´ìŠ¤ì¼€ì´í”„
      const preserved = s.replace(/<strong>(.*?)<\/strong>/g, '___STRONG_START___$1___STRONG_END___');
      const escaped = escapeHtml(preserved);
      return escaped
        .replace(/___STRONG_START___/g, '<strong>')
        .replace(/___STRONG_END___/g, '</strong>')
        .replace(/\n/g,'<br>')
        .replace(/â€¢/g,'â€¢&nbsp;'); 
    }

    // ===== Chat list management =====
    async function updateChatList() {
      if (!userName) return;
      
      try {
        const res = await fetch(`/chat/api/chat/sessions/${userName}`);
        const data = await res.json();
        
        if (data.sessions) {
          const chatList = document.querySelector('.chat-list');
          chatList.innerHTML = '';
          
          data.sessions.forEach(session => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.dataset.sessionId = session.id;
            chatItem.innerHTML = `
              <div class="ci-title">${escapeHtml(session.title)}</div>
              <div class="ci-time">${formatTime(session.updated_at)}</div>
              <button class="delete-btn" onclick="deleteSession(${session.id}, event)" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            `;
            
            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            chatItem.addEventListener('click', () => loadSession(session.id));
            chatList.appendChild(chatItem);
          });
        }
      } catch (e) {
        console.error('ì±„íŒ… ëª©ë¡ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
      }
    }
    
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 24 * 60 * 60 * 1000) {
        return 'ì˜¤ëŠ˜';
      } else if (diff < 48 * 60 * 60 * 1000) {
        return 'ì–´ì œ';
      } else {
        return date.toLocaleDateString();
      }
    }
    
    async function loadSession(sessionId) {
      try {
        const res = await fetch(`/chat/api/chat/sessions/${sessionId}/messages`);
        const data = await res.json();
        
        if (data.messages) {
          // í˜„ì¬ ì„¸ì…˜ ID ì„¤ì •
          currentSessionId = sessionId;
          
          // ì±„íŒ… í™”ë©´ ì´ˆê¸°í™”
          thread.innerHTML = '';
          
          // ë©”ì‹œì§€ë“¤ ë¡œë“œ
          data.messages.forEach(msg => {
            if (msg.role === 'user') {
              addUser(msg.content);
            } else {
              addBot(msg.content);
            }
          });
          
          // ìƒˆ ì±„íŒ… ë·°ë¡œ ì „í™˜
          document.querySelectorAll('.mi').forEach(m => m.classList.remove('active'));
          document.querySelector('.mi[data-view="home"]').classList.add('active');
          document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
          document.getElementById('view-home').classList.add('active');
          document.getElementById('headerTitle').textContent = 'ìºëŸ¿';
        }
      } catch (e) {
        console.error('ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }
    
    // ===== Delete session =====
    window.deleteSession = async function(sessionId, event) {
      // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ (ì±„íŒ… ì•„ì´í…œ í´ë¦­ ë°©ì§€)
      event.stopPropagation();
      
      if (!confirm('ì´ ì±„íŒ… ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const res = await fetch(`/chat/api/chat/sessions/${sessionId}`, {
          method: 'DELETE'
        });
        const data = await res.json();
        
        if (data.status === "success") {
          // í˜„ì¬ ì„¸ì…˜ì´ ì‚­ì œëœ ì„¸ì…˜ì´ë©´ ìƒˆ ì±„íŒ…ìœ¼ë¡œ ì´ˆê¸°í™”
          if (currentSessionId === sessionId) {
            currentSessionId = null;
            thread.innerHTML = '';
            if (phase === 'normal') {
              addBot('ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•´ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? âœ¨');
            }
          }
          
          // ì±„íŒ… ëª©ë¡ ì—…ë°ì´íŠ¸
          updateChatList();
        } else {
          alert('ì„¸ì…˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (e) {
        console.error('ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨:', e);
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì„¸ì…˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===== Send logic =====
    const sendBtn = document.getElementById('sendBtn');
    const promptEl = document.getElementById('prompt');
    sendBtn.addEventListener('click', send);
    promptEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

    // ===== ëª¨ë‹¬ ê¸°ëŠ¥ =====
    const addFileBtn = document.getElementById('addFileBtn');
    const toolsBtn = document.getElementById('toolsBtn');
    const aiEffectBtn = document.getElementById('aiEffectBtn');

    addFileBtn.addEventListener('click', () => openChatModal('fileUploadModal'));
    toolsBtn.addEventListener('click', () => openChatModal('toolsModal'));
    aiEffectBtn.addEventListener('click', () => openChatModal('aiEffectModal'));

    // ì±„íŒ…ì°½ ë‚´ë¶€ ëª¨ë‹¬ ì—´ê¸°
    function openChatModal(modalId) {
      // ë‹¤ë¥¸ ëª¨ë‹¬ë“¤ ë‹«ê¸°
      document.querySelectorAll('.chat-modal').forEach(modal => {
        modal.style.display = 'none';
      });
      document.getElementById(modalId).style.display = 'block';
    }

    // ì±„íŒ…ì°½ ë‚´ë¶€ ëª¨ë‹¬ ë‹«ê¸°
    function closeChatModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // ì±„íŒ…ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.ask') && !e.target.closest('.chat-modal')) {
        document.querySelectorAll('.chat-modal').forEach(modal => {
          modal.style.display = 'none';
        });
      }
    });

    // ë„êµ¬ ì„ íƒ
    function selectTool(tool) {
      closeChatModal('toolsModal');
      console.log('ì„ íƒëœ ë„êµ¬:', tool);
      // ì—¬ê¸°ì— ë„êµ¬ë³„ ê¸°ëŠ¥ êµ¬í˜„
      switch(tool) {
        case 'create-image':
          addBot('ì´ë¯¸ì§€ ë§Œë“¤ê¸° ê¸°ëŠ¥ì„ ì‹œì‘í•©ë‹ˆë‹¤! ğŸ¨');
          break;
        case 'create-video':
          showToast('ì„œë¹„ìŠ¤ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤ :)');
          break;
        case 'enhance-quality':
          showToast('ì„œë¹„ìŠ¤ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤ :)');
          break;
        case 'web-search':
          showToast('ì„œë¹„ìŠ¤ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤ :)');
          break;
        case 'youtube-summary':
          showToast('ì„œë¹„ìŠ¤ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤ :)');
          break;
      }
    }

    // ì‚¬ìš©ì ì´ë¯¸ì§€ ì„ íƒ í¸ì§‘ ì „ì†¡ í•¸ë“¤ëŸ¬
    document.getElementById('userEditSendBtn').addEventListener('click', async ()=>{
      try{
        const f = document.getElementById('userEditFile').files[0];
        const t = document.getElementById('userEditMsg').value || '';
        if (!f && !t){ showToast('ì´ë¯¸ì§€ ë˜ëŠ” ì„¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
        closeChatModal('userEditModal');

        const typingIndicator = addAssistantTyping();
        const fd = new FormData();
        if (f) fd.append('image', f);
        fd.append('message', t);
        fd.append('intent','edit_user_image');
        fd.append('user_name', userName || '');
        if (currentSessionId) fd.append('session_id', currentSessionId.toString());

        const res = await fetch('/chat', { method:'POST', body: fd, credentials:'include' });
        const data = await res.json();

        if (data.status === 'clarify' || (data.meta && data.meta.need_more_info)){
          // Clarify-Once ì§ˆë¬¸ë§Œ í‘œì‹œ (íœë”© IDëŠ” ì„œë²„ ì„¸ì…˜ìœ¼ë¡œ ê´€ë¦¬)
          replaceAssistantText(typingIndicator, data.reply || 'ì›í•˜ëŠ” ìˆ˜ì •ì„ í•œ ì¤„ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.');
          return;
        }
        if (data.url){
          replaceAssistantText(typingIndicator, data.reply || 'ì„¤ëª…í•´ ì£¼ì‹  ëŒ€ë¡œ ì´ë¯¸ì§€ë¥¼ ìˆ˜ì •í• ê²Œìš”.');
          const imgTyping = addImageTypingIndicator();
          replaceAssistantImage(imgTyping, data.url);
          addPill('âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ', 'status ok');
        } else if (data.reply){
          replaceAssistantText(typingIndicator, data.reply);
        } else {
          replaceAssistantText(typingIndicator, 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.');
        }
      }catch(e){
        console.error(e);
        showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      }
    });

    // AI ì´í™íŠ¸ ì„ íƒ
    function selectEffect(effect) {
      closeChatModal('aiEffectModal');
      console.log('ì„ íƒëœ ì´í™íŠ¸:', effect);
      showToast('ì„œë¹„ìŠ¤ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤ :)');
    }

    // ì „ì—­ ë³€ìˆ˜ë¡œ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ê´€ë¦¬
    let uploadedImage = null;
    let uploadedImageElement = null;

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const files = e.target.files;
      if (files.length > 0) {
        const file = files[0]; // ì²« ë²ˆì§¸ íŒŒì¼ë§Œ ì‚¬ìš©
        
        // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
        if (!file.type.startsWith('image/')) {
          alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          return;
        }
        
        // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì œê±°
        if (uploadedImage) {
          removeUploadedImage();
        }
        
        // ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ
        uploadedImage = file;
        displayUploadedImage(file);
        closeChatModal('fileUploadModal');
        
        console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œë¨:', file.name);
      }
    });

    // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ í‘œì‹œ
    function displayUploadedImage(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'uploaded-image';
        img.alt = 'ì—…ë¡œë“œëœ ì´ë¯¸ì§€';
        
        const container = document.createElement('div');
        container.className = 'uploaded-image-container';
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-image-btn';
        removeBtn.innerHTML = 'Ã—';
        removeBtn.onclick = removeUploadedImage;
        
        container.appendChild(img);
        container.appendChild(removeBtn);
        
        // ì…ë ¥ì°½ ì•„ë˜ì— ì´ë¯¸ì§€ í‘œì‹œ
        const askElement = document.querySelector('.ask');
        askElement.appendChild(container);
        
        uploadedImageElement = container;
      };
      reader.readAsDataURL(file);
    }

    // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì œê±°
    function removeUploadedImage() {
      if (uploadedImageElement) {
        uploadedImageElement.remove();
        uploadedImageElement = null;
      }
      uploadedImage = null;
      document.getElementById('fileInput').value = '';
    }

    // ì´ë¯¸ì§€ ìƒì„± ì˜ë„ ê°„ë‹¨ íŒë³„
    function isLikelyImageIntent(text) {
      if (!text) return false;
      const t = String(text).toLowerCase();
      return (
        t.includes('ì´ë¯¸ì§€') || t.includes('ì‚¬ì§„') || t.includes('ê·¸ë¦¼') ||
        t.includes('ê·¸ë ¤') || t.includes('ìƒì„±') || t.includes('ë§Œë“¤') ||
        t.includes('render') || t.includes('image') || t.includes('photo')
      );
    }

    async function send(){
      const text = promptEl.value.trim();
      // í…ìŠ¤íŠ¸ë‚˜ ì´ë¯¸ì§€ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì „ì†¡ ê°€ëŠ¥
      if (!text && !uploadedImage) return;

      // 1) ì‚¬ìš©ì ë§í’ì„  ë¨¼ì € (í…ìŠ¤íŠ¸ + ì²¨ë¶€ ì´ë¯¸ì§€)
      addUser(text, uploadedImage ? [uploadedImage] : null);
      promptEl.value = '';
      
      // 2) ì²« ë©”ì‹œì§€ ì „ì†¡ ì‹œ ì œëª© ìˆ¨ê¸°ê¸°
      const centerTitle = document.querySelector('.center');
      if (centerTitle && centerTitle.style.display !== 'none') {
        centerTitle.style.display = 'none';
        // ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ìƒë‹¨ìœ¼ë¡œ ì˜¬ë¦¬ê¸°
        const firstMessage = document.querySelector('.msg');
        if (firstMessage) {
          firstMessage.style.marginTop = '30px';
        }
      }

      // 2) ì˜¨ë³´ë”© ë‹¨ê³„: ì´ë¦„ ì²˜ë¦¬
      if (phase === 'ask-name' && text){
        if (isLikelyName(text)){
          userName = normalizeName(text);
          
          // ë°ì´í„°ë² ì´ìŠ¤ì— ì‚¬ìš©ì ì €ì¥
          try {
            const userRes = await fetch('/chat/api/user/save', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ name: userName })
            });
            const userData = await userRes.json();
            
            if (userData.status === "success") {
              // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥ (ë°±ì—…ìš©)
              localStorage.setItem('carat_user_name', userName);
              
              printNameSavedAndGuide(userName);
              phase = 'normal';
              
              // ì±„íŒ… ëª©ë¡ ë¡œë“œ
              updateChatList();
              return; // ì´ë¦„ ì…ë ¥ì€ ë°±ì—”ë“œë¡œ ë³´ë‚´ì§€ ì•ŠìŒ
            } else {
              addBot('ì‚¬ìš©ì ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
              return;
            }
          } catch (e) {
            addBot('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
          }
        } else {
          addBot('ì´ë¦„ì„ 2~10ìì˜ í•œê¸€/ì˜ë¬¸ìœ¼ë¡œ ì•Œë ¤ì£¼ì‹œë©´ ì €ì¥í• ê²Œìš”! ğŸ™‚');
          return;
        }
      }

      // 3) ì¼ë°˜ ëŒ€í™”ëŠ” ë°±ì—”ë“œë¡œ
      let statusRow = null;

      // ì–´ì‹œìŠ¤í„´íŠ¸ íƒ€ì´í•‘ í‘œì‹œ: ì´ˆê¸°ì—ëŠ” í•­ìƒ ì ì„¸ê°œ íƒ€ì´í•‘ë§Œ ì‚¬ìš©
      const typingIndicator = addAssistantTyping();
      
      try{
        // FormDataë¥¼ ì‚¬ìš©í•˜ì—¬ í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ ì „ì†¡
        const formData = new FormData();
        formData.append('message', text);
        formData.append('user_name', userName || '');
        if (currentSessionId) {
          formData.append('session_id', currentSessionId.toString());
        }
        
        // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì¶”ê°€
        if (uploadedImage) {
          formData.append('images', uploadedImage);
        }
        
        const res = await fetch('/chat', {
          method: 'POST',
          body: formData,
          credentials: 'include'  // ì¿ í‚¤ í¬í•¨
        });
        const data = await res.json();
        
        console.log('Chat response:', data);
        
        // ìƒˆë¡œìš´ API ì‘ë‹µ í˜•ì‹ ì²˜ë¦¬
        if (data.url) {
          // 1) ìƒì„± í™•ì • ë©˜íŠ¸(ë§í’ì„ )
          if (data.reply) {
            replaceAssistantText(typingIndicator, data.reply);
          } else {
            replaceAssistantText(typingIndicator, 'ì´ë¯¸ì§€ë¥¼ ìƒì„±í• ê²Œìš”. ğŸ¨');
          }
          // 2) ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì¸ë””ì¼€ì´í„° (ë§í’ì„  ë°–, ì‹¤ì œ ì´ë¯¸ì§€ ì‘ë‹µì¼ ë•Œë§Œ í‘œì‹œ)
          const imgTyping = addImageTypingIndicator();
          // 3) ì´ë¯¸ì§€ ì¹´ë“œ í‘œì‹œ (ë³„ë„ í–‰)
          replaceAssistantImage(imgTyping, data.url);
          // 4) ì™„ë£Œ pill (ë§í’ì„  ë°–)
          addPill('âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ', 'status ok');
          // 4) ì´ë¯¸ì§€ ìº¡ì…˜(ì‘ì€ íšŒìƒ‰ ê¸€ì”¨, ë§í’ì„  ì—†ì´)
          if (data.meta && data.meta.desc) {
            const captionRow = document.createElement('div');
            captionRow.className = 'msg';
            captionRow.innerHTML = `<div style="color:#6b7280;font-size:12px;max-width:540px;margin:4px 0 0 0;text-align:left;">${escapeHtml(data.meta.desc)}</div>`;
            thread.appendChild(captionRow);
            scrollToBottom();
          }
          // 5) ìµœì¢… ìš”ì•½(ë§í’ì„ )
          if (data.meta && data.meta.summary) {
            addBot(data.meta.summary);
          }
        } else if (data.reply) {
          // í…ìŠ¤íŠ¸ ì‘ë‹µ
          replaceAssistantText(typingIndicator, data.reply);
              
              // ì´ë¦„ ë³€ê²½ ê°ì§€ (LLM ì‘ë‹µì—ì„œ "ì´ë¦„ì„ ì—…ë°ì´íŠ¸" í‚¤ì›Œë“œ í™•ì¸)
              if (data.reply.includes('ì´ë¦„ì„ ì—…ë°ì´íŠ¸') || data.reply.includes('ì•„,') && data.reply.includes('ë‹˜ì´ ì•„ë‹ˆë¼')) {
                // ìƒˆë¡œìš´ ì´ë¦„ ì¶”ì¶œ (LLM ì‘ë‹µì—ì„œ ì´ë¦„ ì°¾ê¸°)
                const nameMatch = data.reply.match(/ì•„, (.+?)ë‹˜ì´ ì•„ë‹ˆë¼ (.+?)ë‹˜ì´ì‹œêµ°ìš”/);
                if (nameMatch) {
                  const newName = nameMatch[2];
                  userName = newName;
                  updateUserDisplay(newName);
                  
                  // DBì— ìƒˆ ì´ë¦„ ì €ì¥
                  fetch('/chat/api/user/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: newName })
                  });
                }
              }
            }
        
        // ì„¸ì…˜ ID ì—…ë°ì´íŠ¸ (ìƒˆ ì„¸ì…˜ì´ ìƒì„±ëœ ê²½ìš°)
        if (data.meta && data.meta.session_id) {
          currentSessionId = data.meta.session_id;
          // ì‚¬ìš©ì ì´ë¦„ì´ í™•ì •ëœ ìƒíƒœë¼ë©´ ì„¸ì…˜ ëª©ë¡ì„ ê°±ì‹ í•˜ì—¬ ì‚¬ì´ë“œë°”ì— ëˆ„ì 
          if (userName) {
            updateChatList();
          }
        }
        
        // 5) ì…ë ¥/ì²¨ë¶€ ì´ˆê¸°í™”
        if (uploadedImage) {
          removeUploadedImage();
        }
      }catch(e){
        console.error(e);
        replaceAssistantText(typingIndicator, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
      }
    }

    // ì–´ì‹œìŠ¤í„´íŠ¸ íƒ€ì´í•‘ í‘œì‹œ
    function addAssistantTyping(){
      const el = document.createElement('div');
      el.className = 'msg bot';
      el.dataset.role = 'typing';
      el.innerHTML = `
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>`;
      thread.appendChild(el);
      scrollBottom();
      return el;
    }

    // í…ìŠ¤íŠ¸ ì‘ë‹µ â†’ ë§í’ì„ ìœ¼ë¡œ êµì²´
    function replaceAssistantText(typingEl, html){
      typingEl.className = 'msg bot';
      typingEl.innerHTML = `<div class="bubble">${html}</div>`;
      typingEl.removeAttribute('data-role');
      scrollBottom();
    }

    // ì´ë¯¸ì§€ ì‘ë‹µ â†’ ë§í’ì„  ì œê±°, ì¹´ë“œë¡œ êµì²´
    function replaceAssistantImage(typingEl, url){
      typingEl.className = 'row';               // ë§í’ì„  í–‰ì´ ì•„ë‹ˆë¼ ê°€ìš´ë° ì •ë ¬ í–‰
      typingEl.innerHTML = `
        <figure class="img-card">
          <div class="img-wrap" style="max-width: 540px; margin: 0 auto;"><img src="${url}" alt=""></div>
          <div class="actions">
            <button class="btn" onclick="downloadImage('${url}')">ì €ì¥</button>
            <button class="btn" onclick="openEditor('${url}')">ì„ íƒ ìˆ˜ì •</button>
            <button class="btn" onclick="regenerateImage('${url}')">ë‹¤ì‹œ ìƒì„±</button>
      </div>
        </figure>`;
      typingEl.removeAttribute('data-role');
      scrollBottom();
    }

    function scrollBottom(){
      requestAnimationFrame(()=> window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'}));
    }

    // ì´ë¯¸ì§€ ì €ì¥/í¸ì§‘ ë²„íŠ¼ìš© í•¨ìˆ˜ë“¤
    window.downloadImage = async function(url){
      const a = document.createElement('a');
      a.href = url; 
      a.download = 'image.png'; 
      a.click();
    }
    
    window.openEditor = function(url){
      // ë™ì  í¸ì§‘ ì˜¤ë²„ë ˆì´ ìƒì„±
      const overlay = document.createElement('div');
      overlay.id = 'editor-overlay';
      overlay.style = 'position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;';

      const modal = document.createElement('div');
      modal.style = 'background:#fff;width:min(960px,96vw);max-height:90vh;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);';
      overlay.appendChild(modal);

      const header = document.createElement('div');
      header.style = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;';
      header.innerHTML = '<h3 style="margin:0;font-size:16px">ì„ íƒ í¸ì§‘</h3><button class="btn" id="editor-close" aria-label="ë‹«ê¸°">Ã—</button>';
      modal.appendChild(header);

      const body = document.createElement('div');
      body.style = 'display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;';
      modal.appendChild(body);

      const canvasWrap = document.createElement('div');
      canvasWrap.style = 'position:relative;width:540px;max-width:100%';
      body.appendChild(canvasWrap);

      const baseImg = document.createElement('img');
      baseImg.src = url;
      baseImg.alt = 'í¸ì§‘ ì´ë¯¸ì§€';
      baseImg.style = 'display:block;width:100%;border:1px solid #e5e7eb;border-radius:8px;';
      canvasWrap.appendChild(baseImg);

      const selCanvas = document.createElement('canvas');
      selCanvas.style = 'position:absolute;left:0;top:0;width:100%;height:100%;cursor:crosshair';
      canvasWrap.appendChild(selCanvas);

      // ì˜¤í”„ìŠ¤í¬ë¦° ë§ˆìŠ¤í¬ ìº”ë²„ìŠ¤ (í° ë°°ê²½ + ê²€ì • ë¸ŒëŸ¬ì‹œ)
      const maskCanvas = document.createElement('canvas');

      const side = document.createElement('div');
      side.style = 'flex:1;min-width:240px';
      side.innerHTML = `
        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:6px">ë¸ŒëŸ¬ì‹œ í¬ê¸°</label>
        <input id="brushSize" type="range" min="4" max="48" value="16" style="width:100%;margin-bottom:10px">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <button class="btn" id="btnClear">ì„ íƒ ì§€ìš°ê¸°</button>
          <button class="btn" id="btnInvert">ë°˜ì „</button>
            </div>
        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:6px">í¸ì§‘ ì§€ì‹œë¬¸</label>
        <textarea id="editorPrompt" rows="6" style="width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:8px">ì„ íƒí•œ ì˜ì—­ë§Œ ìˆ˜ì •í•˜ê³ , ë‚˜ë¨¸ì§€ ì˜ì—­ì€ ë³€ê²½í•˜ì§€ ë§ì•„ì£¼ì„¸ìš”. ìºë¦­í„°ì˜ ìŠ¤íƒ€ì¼Â·ì„  ë‘ê»˜Â·ìœ¤ê³½Â·ì¡°ëª…ì€ ìœ ì§€í•´ì£¼ì„¸ìš”. ì„ íƒ ë¶€ìœ„ë¥¼ ì£¼ë³€ ìƒ‰ìƒê³¼ ë™ì¼í•œ ìƒ‰ìœ¼ë¡œ ë³€ê²½í•˜ê³ , ìŒì˜ë„ ê¸°ì¡´ í†¤ì„ ë”°ë¥´ì„¸ìš”.</textarea>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" id="btnSubmit">ì„ íƒ ë¶€ë¶„ë§Œ ìˆ˜ì •</button>
          </div>
      `;
      body.appendChild(side);

      document.body.appendChild(overlay);

      // ì¢Œí‘œ/ê·¸ë¦¬ê¸° ì„¸íŒ…
      let drawing = false;
      let lastX = 0, lastY = 0;
      let brush = 16;

      function setupCanvases() {
        const rect = baseImg.getBoundingClientRect();
        const displayW = rect.width;
        const displayH = rect.height;

        // ì‹¤ì œ ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°
        const imgW = baseImg.naturalWidth;
        const imgH = baseImg.naturalHeight;

        // ì˜¤ë²„ë ˆì´ ìº”ë²„ìŠ¤ëŠ” í‘œì‹œ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ê·¸ë¦¼ (ì‹œê°í™”ìš©)
        selCanvas.width = displayW;
        selCanvas.height = displayH;

        // ë§ˆìŠ¤í¬ ìº”ë²„ìŠ¤ëŠ” ì›ë³¸ í•´ìƒë„ë¡œ ìœ ì§€ (ì •ë°€ ë§ˆìŠ¤í¬)
        maskCanvas.width = imgW;
        maskCanvas.height = imgH;

        // ë§ˆìŠ¤í¬ëŠ” í°ìƒ‰ìœ¼ë¡œ ì´ˆê¸°í™”
        const mctx = maskCanvas.getContext('2d');
        mctx.fillStyle = '#ffffff';
        mctx.fillRect(0,0,imgW,imgH);
      }

      baseImg.onload = () => setupCanvases();

      function getCoords(e) {
        const r = selCanvas.getBoundingClientRect();
        const x = Math.max(0, Math.min(e.clientX - r.left, r.width));
        const y = Math.max(0, Math.min(e.clientY - r.top, r.height));
        // í‘œì‹œ ì¢Œí‘œ -> ì›ë³¸ ì¢Œí‘œë¡œ ë§¤í•‘ (ë§ˆìŠ¤í¬ìš©)
        const scaleX = maskCanvas.width / selCanvas.width;
        const scaleY = maskCanvas.height / selCanvas.height;
        return {dx:x, dy:y, mx: x*scaleX, my: y*scaleY};
      }

      function drawLine(x0,y0,x1,y1) {
        // ì‹œê° ì˜¤ë²„ë ˆì´ (ë°˜íˆ¬ëª… ë¹¨ê°•)
        const vctx = selCanvas.getContext('2d');
        vctx.strokeStyle = 'rgba(0,0,0,0.65)';
        vctx.lineWidth = brush;
        vctx.lineCap = 'round';
        vctx.lineJoin = 'round';
        vctx.beginPath();
        vctx.moveTo(x0,y0);
        vctx.lineTo(x1,y1);
        vctx.stroke();

        // ë§ˆìŠ¤í¬ (ê²€ì •)
        const mctx = maskCanvas.getContext('2d');
        mctx.strokeStyle = '#000000';
        mctx.lineWidth = Math.round(brush * (maskCanvas.width/selCanvas.width));
        mctx.lineCap = 'round';
        mctx.lineJoin = 'round';
        mctx.beginPath();
        const s0x = x0 * (maskCanvas.width/selCanvas.width);
        const s0y = y0 * (maskCanvas.height/selCanvas.height);
        const s1x = x1 * (maskCanvas.width/selCanvas.width);
        const s1y = y1 * (maskCanvas.height/selCanvas.height);
        mctx.moveTo(s0x,s0y);
        mctx.lineTo(s1x,s1y);
        mctx.stroke();
      }

      selCanvas.addEventListener('mousedown', (e)=>{
        drawing = true;
        const {dx,dy} = getCoords(e);
        lastX = dx; lastY = dy;
      });
      selCanvas.addEventListener('mousemove', (e)=>{
        if (!drawing) return;
        const {dx,dy} = getCoords(e);
        drawLine(lastX,lastY,dx,dy);
        lastX = dx; lastY = dy;
      });
      ['mouseup','mouseleave'].forEach(ev=> selCanvas.addEventListener(ev, ()=>{ drawing=false; }));

      // ì»¨íŠ¸ë¡¤ ë°”ì¸ë”©
      overlay.querySelector('#brushSize').addEventListener('input', (e)=>{ brush = parseInt(e.target.value||'16',10); });
      overlay.querySelector('#editor-close').addEventListener('click', ()=>{ overlay.remove(); });
      overlay.querySelector('#btnClear').addEventListener('click', ()=>{
        const vctx = selCanvas.getContext('2d');
        vctx.clearRect(0,0,selCanvas.width, selCanvas.height);
        const mctx = maskCanvas.getContext('2d');
        mctx.fillStyle = '#ffffff';
        mctx.fillRect(0,0,maskCanvas.width, maskCanvas.height);
      });
      overlay.querySelector('#btnInvert').addEventListener('click', ()=>{
        // ë§ˆìŠ¤í¬ ë°˜ì „ (í°<->ê²€ì •)
        const mctx = maskCanvas.getContext('2d');
        const img = mctx.getImageData(0,0,maskCanvas.width, maskCanvas.height);
        const d = img.data;
        for (let i=0; i<d.length; i+=4){
          // ë‹¨ìƒ‰(ê·¸ë ˆì´) ê¸°ì¤€: R=G=B -> ë°˜ì „
          const inv = 255 - d[i];
          d[i]=inv; d[i+1]=inv; d[i+2]=inv;
        }
        mctx.putImageData(img,0,0);
        // ì‹œê° ì˜¤ë²„ë ˆì´ëŠ” ìœ ì§€
      });

      overlay.querySelector('#btnSubmit').addEventListener('click', ()=>{
        // í¸ì§‘ ìš”ì²­ ì „ì†¡
        const promptText = overlay.querySelector('#editorPrompt').value || '';
        const typingIndicator = addAssistantTyping();
        maskCanvas.toBlob(async (blob)=>{
          try{
            const selectionFile = new File([blob], 'selection.png', {type:'image/png'});
            const fd = new FormData();
            fd.append('message', promptText || 'ì„ íƒ ì˜ì—­ë§Œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.');
            fd.append('user_name', userName || '');
            if (currentSessionId) fd.append('session_id', currentSessionId.toString());
            fd.append('image_path', url); // ì›ë³¸ì€ ì„œë²„ì˜ ì •ì  ê²½ë¡œ URL
            fd.append('selection', selectionFile);

            // ì˜¤ë²„ë ˆì´ ë‹«ê¸°
            overlay.remove();

            const res = await fetch('/chat', { method:'POST', body: fd, credentials:'include' });
            const data = await res.json();

            if (data.url) {
              // ìƒì„± í™•ì • ë©˜íŠ¸
              if (data.reply) {
                replaceAssistantText(typingIndicator, data.reply);
              } else {
                replaceAssistantText(typingIndicator, 'ì´ë¯¸ì§€ë¥¼ ìƒì„±í• ê²Œìš”. ğŸ¨');
              }
              // ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì¸ë””ì¼€ì´í„° â†’ ì´ë¯¸ì§€ë¡œ êµì²´
              const imgTyping = addImageTypingIndicator();
              replaceAssistantImage(imgTyping, data.url);
              addPill('âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ', 'status ok');
              if (data.meta && data.meta.desc){
                const captionRow = document.createElement('div');
                captionRow.className = 'msg';
                captionRow.innerHTML = `<div style="color:#6b7280;font-size:12px;max-width:540px;margin:4px 0 0 0;text-align:left;">${escapeHtml(data.meta.desc)}</div>`;
                thread.appendChild(captionRow);
                scrollToBottom();
              }
              if (data.meta && data.meta.summary){
                addBot(data.meta.summary);
              }
              if (data.meta && data.meta.session_id){
                currentSessionId = data.meta.session_id;
                if (userName) updateChatList();
              }
            } else if (data.reply) {
              replaceAssistantText(typingIndicator, data.reply);
            } else {
              replaceAssistantText(typingIndicator, 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.');
            }
          }catch(e){
            console.error(e);
            replaceAssistantText(typingIndicator, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
          }
        }, 'image/png');
      });
    }

    // ë§ˆí¬ë‹¤ìš´ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
    window.downloadChatAsMarkdown = function() {
      const messages = thread.querySelectorAll('.msg');
      let markdown = '# ìºëŸ¿ê³¼ì˜ ëŒ€í™”\n\n';
      
      messages.forEach((msg, index) => {
        const isUser = msg.classList.contains('user');
        const bubble = msg.querySelector('.bubble');
        const imgCard = msg.querySelector('.img-card');
        
        if (bubble) {
          const content = bubble.textContent || bubble.innerText;
          if (isUser) {
            markdown += `## ì‚¬ìš©ì\n${content}\n\n`;
          } else {
            markdown += `## ìºëŸ¿\n${content}\n\n`;
          }
        } else if (imgCard) {
          const img = imgCard.querySelector('img');
          if (img) {
            markdown += `## ìºëŸ¿\n![ìƒì„±ëœ ì´ë¯¸ì§€](${img.src})\n\n`;
          }
        }
      });
      
      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ìºëŸ¿_ëŒ€í™”_${new Date().toISOString().slice(0, 10)}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ í•­ìƒ ì˜¨ë³´ë”©ë¶€í„°
    document.addEventListener('DOMContentLoaded', bootOnboarding);

    window.regenerateImage = async function(url){
      const typingIndicator = addAssistantTyping();
      try{
        const fd = new FormData();
        fd.append('message','ë‹¤ì‹œ ìƒì„±');
        fd.append('user_name', userName || '');
        if (currentSessionId) fd.append('session_id', currentSessionId.toString());
        const res = await fetch('/chat', { method:'POST', body: fd, credentials:'include' });
        const data = await res.json();
        if (data.url){
          replaceAssistantText(typingIndicator, data.reply || 'ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ìƒì„±í• ê²Œìš”.');
          const imgTyping = addImageTypingIndicator();
          replaceAssistantImage(imgTyping, data.url);
          addPill('âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ', 'status ok');
          if (data.meta && data.meta.desc){
            const captionRow = document.createElement('div');
            captionRow.className = 'msg';
            captionRow.innerHTML = `<div style="color:#6b7280;font-size:12px;max-width:540px;margin:4px 0 0 0;text-align:left;">${escapeHtml(data.meta.desc)}</div>`;
            thread.appendChild(captionRow);
            scrollToBottom();
          }
          if (data.meta && data.meta.summary){ addBot(data.meta.summary); }
        } else if (data.reply){
          replaceAssistantText(typingIndicator, data.reply);
        } else {
          replaceAssistantText(typingIndicator, 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.');
        }
      }catch(e){
        console.error(e);
        replaceAssistantText(typingIndicator, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
      }
    }
  </script>
</body>
</html>